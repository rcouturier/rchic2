#!/bin/bash
# Rscript wrapper for portable R on macOS
# Handles both Intel (x86_64) and ARM64 architectures

SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
R_FRAMEWORK="$SCRIPT_DIR/../R.framework"

# Detect architecture
MACHINE_ARCH=$(uname -m)
if [ "$MACHINE_ARCH" = "arm64" ]; then
  PREFERRED_SUFFIX="arm64"
else
  PREFERRED_SUFFIX="x86_64"
fi

# First pass: prefer matching architecture in Versions directory
R_HOME=""
if [ -d "$R_FRAMEWORK/Versions" ]; then
  for ver in "$R_FRAMEWORK/Versions"/*; do
    case "$(basename "$ver")" in
      *${PREFERRED_SUFFIX}*)
        if [ -d "$ver/Resources/bin" ]; then
          R_HOME="$ver/Resources"
          break
        fi
        ;;
    esac
  done

  # Second pass: fall back to any available version
  if [ -z "$R_HOME" ]; then
    for ver in "$R_FRAMEWORK/Versions"/*; do
      if [ -d "$ver/Resources/bin" ]; then
        R_HOME="$ver/Resources"
        break
      fi
    done
  fi
fi

# Last resort: try Resources symlink
if [ -z "$R_HOME" ] && [ -d "$R_FRAMEWORK/Resources/bin" ]; then
  R_HOME="$R_FRAMEWORK/Resources"
fi

if [ -z "$R_HOME" ] || [ ! -d "$R_HOME/bin" ]; then
  echo "ERROR: Cannot find R_HOME" >&2
  exit 1
fi

R_BIN="$R_HOME/bin/R"
if [ ! -f "$R_BIN" ]; then
  echo "ERROR: R binary not found at $R_BIN" >&2
  exit 1
fi

export R_HOME
export DYLD_LIBRARY_PATH="$R_HOME/lib:${DYLD_LIBRARY_PATH:-}"

exec "$R_BIN" --slave --no-restore "$@"
